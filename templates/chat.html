{% extends "base.html" %}
{% block content %}
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="notification is-{{ category }}">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}


<section class="section">
  <div class="container">
    <h2 class="title is-3 has-text-centered mb-5">–ß–∞—Ç</h2>

    <div class="columns">
      <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: —á–∞—Ç -->
      <div class="column is-two-thirds">
        <div class="box" style="height: 300px; overflow-y: auto;">
          {% for msg in messages %}
            {% if msg.is_system %}
              <div class="notification is-success is-light has-text-centered my-2">
                {{ msg.content }}
              </div>
            {% else %}
              <div class="mb-2">
                <p>
                  <strong class="has-text-{{ 'primary' if msg.sender.user_id == current_user_id else 'dark' }}">
                    {{ '–í—ã' if msg.sender.user_id == current_user_id else '–°–æ–±–µ—Å–µ–¥–Ω–∏–∫' }}:
                  </strong>
                  {{ msg.content }}
                </p>
              </div>
            {% endif %}
          {% endfor %}
        </div>

        {% if chat.is_active %}
          <form method="post" class="mt-4">
            <div class="field">
              <div class="control">
                <textarea name="message" class="textarea" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ..." required></textarea>
              </div>
            </div>
            <div class="field is-grouped is-justify-content-flex-end">
              <div class="control">
                <button class="button is-primary is-rounded">
                  <span class="icon"><i class="fas fa-paper-plane"></i></span>
                  <span>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</span>
                </button>
              </div>
            </div>
          </form>
        {% else %}
          <div class="notification is-success has-text-centered mt-4">
            –ß–∞—Ç –∑–∞–∫—Ä—ã—Ç. –°–¥–µ–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.
          </div>
        {% endif %}

      </div>

      <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ —Å–¥–µ–ª–∫–µ -->
      <div class="column is-one-third">
        <div class="box">
          <h3 class="title is-5">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ —Å–¥–µ–ª–∫–µ</h3>
          <p><strong>–¢–æ–≤–∞—Ä:</strong> {{ chat.product.title }}</p>
          <p><strong>–¶–µ–Ω–∞:</strong> {{ chat.product.price_in_cents / 100 }} TON</p>
          <p><strong>–ü—Ä–æ–¥–∞–≤–µ—Ü:</strong> {{ chat.seller.full_name }}</p>
          <p><strong>–ü–æ–∫—É–ø–∞—Ç–µ–ª—å:</strong> {{ chat.buyer.full_name }}</p>
          <p><strong>–ö–æ–¥ —Å–¥–µ–ª–∫–∏:</strong> {{ chat.deal_code }}</p>
          <hr>
          <p><strong>–°—Ç–∞—Ç—É—Å:</strong>
            {% if deal.status == "awaiting_payment" %} –û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã
            {% elif deal.status == "paid" %} –û–ø–ª–∞—á–µ–Ω, –∂–¥—ë—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏
            {% elif deal.status == "shipped" %} –û—Ç–ø—Ä–∞–≤–ª–µ–Ω
            {% elif deal.status == "confirmed" %} –ü–æ–ª—É—á–µ–Ω
            {% elif deal.status == "finished" %} –ó–∞–≤–µ—Ä—à—ë–Ω
            {% else %} –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ
            {% endif %}
          </p>

          <!-- –ö–Ω–æ–ø–∫–∏ –æ–ø–ª–∞—Ç—ã -->
          <div class="mt-4">
            <a class="button is-info is-fullwidth mb-2" href="{{ payment_url }}" target="_blank">–û—Ç–ø—Ä–∞–≤–∏—Ç—å TON</a>

            <form method="post" action="{{ url_for('check_payment', chat_id=chat.chat_id) }}">
              <button class="button is-light is-fullwidth">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–ø–ª–∞—Ç—É</button>
            </form>

            {% if current_user_id == chat.seller.user_id and deal.status == "paid" %}
            <form method="post" action="{{ url_for('mark_shipped', deal_id=deal.deal_id) }}">
                <button class="button is-success is-light is-fullwidth">üì¶ –¢–æ–≤–∞—Ä –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω</button>
            </form>
            {% endif %}

          </div>

          <!-- ‚úÖ –ö–Ω–æ–ø–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è -->
          {% if current_user_id == chat.buyer.user_id and deal.status == 'shipped' %}
          <form method="post" action="{{ url_for('confirm_delivery', chat_id=chat.chat_id) }}">
            <button class="button is-success is-fullwidth mt-3">–¢–æ–≤–∞—Ä –ø–æ–ª—É—á–µ–Ω</button>
          </form>
          {% endif %}
        </div>
      </div>

    </div>
  </div>
</section>
{% endblock %}
